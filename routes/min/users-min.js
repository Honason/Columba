var express=require("express"),router=express.Router(),passport=require("passport"),LocalStrategy=require("passport-local").Strategy,jwt=require("jsonwebtoken"),User=require("../models/user");router.get("/",function(e,s,r){s.redirect("/")}),router.post("/getall",function(e,s,r){User.find({},function(e,r){e?console.log(e):s.json({success:!0,users:r})})}),router.post("/isemailregistered",function(e,s,r){var o=e.body.email;null!==o&&""!==o?User.getUserByEmail(o,function(e,r){if(e)throw e;r?s.json({success:!0,emailRegistered:!0}):s.json({success:!0,emailRegistered:!1})}):s.json({success:!1})}),router.post("/register",function(e,s,r){var o=e.body.name,t=e.body.email,i=e.body.password;e.checkBody("name","Name field is required").notEmpty(),e.checkBody("email","Email field is required").notEmpty(),e.checkBody("email","Email not valid").isEmail(),e.checkBody("password","Password field is required").notEmpty();var n=e.validationErrors();n?s.json({success:!1,message:"Error.",errors:n}):User.getUserByEmail(t,function(e,r){if(e)throw e;if(r)console.log("User already registered"),s.json({success:!1,message:"This email address is already registered."});else{var n=new User({name:o,email:t,password:i});User.createUser(n,function(e,s){if(e)throw e;console.log(s)}),s.json({success:!0,message:"Registered"})}})}),passport.serializeUser(function(e,s){s(null,e.id)}),passport.deserializeUser(function(e,s){User.getUserById(e,function(e,r){s(e,r)})}),passport.use(new LocalStrategy({usernameField:"email",passwordField:"password"},function(e,s,r){User.getUserByEmail(e,function(e,o){if(e)throw e;return o?void User.comparePassword(s,o.password,function(e,s){if(e)throw e;return s?r(null,o):(console.log("Invalid password"),r(null,!1,{message:"Invalid password"}))}):(console.log("Unknown user"),r(null,!1,{message:"Unknown User"}))})})),router.post("/login",passport.authenticate("local"),function(e,s){console.log("Authentivation Successful");var r=jwt.sign(e.user,"supersecret",{expiresInMinutes:1});s.json({success:!0,message:"You are authenticated",name:e.user.name,token:r})}),router.get("/logout",function(e,s){e.logout(),e.flash("success","You have logged out"),s.redirect("/users/login")}),module.exports=router;